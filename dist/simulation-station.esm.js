class t{constructor(t){this.avg_size=t,this.n=0,this.arr=[],this.lastTime=performance.now()}update(){const t=performance.now()-this.lastTime;this.arr.length==this.avg_size?(this.arr[this.n++]=t,this.n%=this.avg_size):this.arr.push(t),this.lastTime=performance.now()}getFramerate(){return 1e3/(this.arr.reduce((t,e)=>t+e)/this.arr.length)}}class e{constructor(t={}){this.visible=!0,this.static=t.static}show(){this.visible=!0}hide(){this.visible=!1}}function i(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,document.body.appendChild(i),i}function s(t,e){const i=document.createElement("button");return i.innerHTML=e,i.addEventListener("click",t),i}function r(t,e){return Array.isArray(t)?t[Math.floor(Math.random()*t.length)]:Math.random()*(e-t)+t}function n(t,e,i,s,r){return s+(t-e)/(i-e)*(r-s)}function o(t){const e=t=>{const e=((t,e)=>t<0?t+e:t%e)(t,1);return e<1/6?6*e:e<.5?1:e<2/3?6*(2/3-e):0},i=e(t+1/3),s=e(t),r=e(t-1/3);return[Math.round(255*i),Math.round(255*s),Math.round(255*r)]}function a(t,e,i){return t<e?e:t>i?i:t}function h(t,e,i){return i=a(i,0,1),[t[0]+(e[0]-t[0])*i,t[1]+(e[1]-t[1])*i,t[2]+(e[2]-t[2])*i]}function c(t){return Math.random()<t}function l(...t){let e=Math.random()*t.reduce((t,[e,i])=>t+e,0);for(const[i,s]of t)e<i&&s(),e-=i}class u{constructor(t,e){this.x=t,this.y=e}}class d{constructor(t,e,i,s){t instanceof d&&(this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h),this.x=t,this.y=e,this.w=i,this.h=s}contains(t){return t.x>=this.x&&t.y>=this.y&&t.x<this.x+this.w&&t.y<this.y+this.h}copy(){return new d(this)}}class g{constructor(t,e,i){this.x=t,this.y=e,this.r=i}contains(t){return(t.x-this.x)**2+(t.y-this.y)**2<=this.r**2}intersects(t){const e=new u(this.x,this.y),i=[new d(t.x-this.r,t.y,t.w+this.r,t.h),new d(t.x,t.y-this.x,t.w,t.h+this.r),new g(t.x,t.y,this.r),new g(t.x+t.w,t.y,this.r),new g(t.x,t.y+t.h,this.r),new g(t.x+t.w,t.y+t.h,this.r)];for(const t of i)if(t.contains(e))return!0;return!1}}class f{constructor(t,e=1,i=!0){this.boundary=t,this.capacity=e,this.agents=[],i&&(this.isRoot=!0)}makeChild(t,e){return new f(new d(this.boundary.x+t*this.boundary.w/2,this.boundary.y+e*this.boundary.h/2,this.boundary.w/2,this.boundary.h/2),this.capacity)}makeParent(t,e,i){this.isRoot=!1;const s=new f(new d(this.boundary.x-t*this.boundary.w,this.boundary.y-e*this.boundary.h,2*this.boundary.w,2*this.boundary.h),this.capacity,!0);return s[i]=this,s}divide(){this.ne||(this.ne=this.makeChild(1,0)),this.nw||(this.nw=this.makeChild(0,0)),this.sw||(this.sw=this.makeChild(0,1)),this.se||(this.se=this.makeChild(1,1)),this.divided=!0}insert(t){if(this.boundary.contains(t))return this.agents.length<this.capacity?this.agents.push(t):this.overflow(t),this;if(this.isRoot){let e,i=this;const s=function(){let{x:e,y:s}=i.boundary;return t.x<e&&t.y<s?[1,1,"se"]:t.x>=e&&t.y<s?[0,1,"sw"]:t.x<e&&t.y>=s?[1,0,"ne"]:t.x>=e&&t.y>=s?[0,0,"nw"]:void 0}();do{(e=i.makeParent(...s)).divide(),i=e}while(!e.boundary.contains(t));return e}}overflow(t){this.divided||this.divide(),this.ne.insert(t),this.nw.insert(t),this.sw.insert(t),this.se.insert(t)}getInCircle(t,e,i){return this.get(new g(t,e,i))}get(t,e=[]){if(!t.intersects(this.boundary))return e;for(let i of this.agents)t.contains(i)&&e.push(i);return this.divided&&(this.ne.get(t,e),this.nw.get(t,e),this.sw.get(t,e),this.se.get(t,e)),e}*entries(){yield*this.agents.values(),this.divided&&(yield*this.ne.entries(),yield*this.nw.entries(),yield*this.sw.entries(),yield*this.se.entries())}[Symbol.iterator](){return this.entries()}}class m{constructor(){this.agents={},this.ungrouped=[]}copy(){const t={};for(const[e,i]of Object.entries(this.agents)){t[e]=[];for(const s of i){const i=Object.assign(new s.constructor,s);t[e].push(i),i._ssinternal.original=s}}const e=[];for(const t of this.ungrouped){const i=Object.assign(new t.constructor,t);e.push(i),i._ssinternal.original=t}const i=new m;return i.agents=t,i.ungrouped=e,i}push(t){if(t.constructor.getTexture){const e=t.constructor.getTexture();this.agents[e]||(this.agents[e]=[]),this.agents[e].push(t)}else this.ungrouped.push(t)}*getPartitioned(){for(const t in this.agents)yield[this.agents[t],t];for(const t in this.ungrouped)yield[[t],t.getTexture()]}*[Symbol.iterator](){for(const t in this.agents)yield*this.agents[t].values();yield*this.ungrouped.values()}}class p{constructor(t,e,i,s){if(t instanceof p){this.w=t.w,this.h=t.h,this.cells=[];for(let e=0;e<this.w;e++){this.cells.push([]);for(let i=0;i<this.h;i++){const s=t.cells[e][i],r=Object.assign(new t.cells[e][i].constructor,s);r.curr=s,this.cells[e].push(r)}}}else{const n=t;this.w=n,this.h=e,this.cells=[],i instanceof Function&&(i=[i]);for(let t=0;t<n;t++){this.cells.push([]);for(let n=0;n<e;n++){const e=new(r(i))(t,n,s);e.init(),this.cells[t].push(e)}}}}copy(){return new p(this)}get(t,e){const i=(t,e)=>(t%e+e)%e;return this.cells[i(t,this.w)][i(e,this.h)]}set(t){return this.cells[t.x][t.y]=t}*[Symbol.iterator](){for(let t=0;t<this.w;t++)for(let e=0;e<this.h;e++)yield this.cells[t][e]}}const y=[[1,0],[0,1],[-1,0],[0,-1]],x=[[1,1],[-1,1],[-1,-1],[1,-1]],E=[...y,...x];class w{constructor(t,e,i){this.x=t,this.y=e,this._ssinternal={},this._ssinternal.layer=i}become(t){this._ssinternal.become_cell=t}getMooreDistances(){return E.map(t=>Math.sqrt(t[0]*t[0]+t[1]*t[1]))}getNeighs(t,e=this._ssinternal.layer){return t.map(([t,i])=>e.old_cells.get(this.x+t,this.y+i))}getVonNeumannNeighbours(t){return this.getNeighs(y,t)}getDiagonalNeighbours(t){return this.getNeighs(x,t)}getMooreNeighbours(t){return this.getNeighs(E,t)}getRandomNeigh(t=this._ssinternal.layer){const e=this.x,i=this.y;return t.cells.get(...r([[e+1,i],[e,i+1],[e-1,i],[e,i-1]]))}on(t){return t.cells.get(this.x,this.y)}random(){}init(){}getColor(){return[255,0,255]}update(){}onClick(){}}class T extends w{constructor(...t){super(...t),this._ssinternal.is_empty_cell=!0}getColor(){return null}getColorRaw(){return null}}class b extends e{constructor(t,e){super(e),this.options=e,this.cellTypes=t}init(t,e,i){this.nxCells=t,this.nyCells=e,this.cellxSize=1,this.cellySize=1,this.cells=new p(t,e,this.cellTypes,this),this.running=!1}forEachCell(t,e=0,i=0,s=this.nxCells,r=this.nyCells,n){for(let n=e;n<s;n++)for(let e=i;e<r;e++)t(this.cells.get(n,e))}onClick(t,e){const i=Math.floor(t/this.cellxSize),s=Math.floor(e/this.cellySize);this.cells.get(i,s).onClick()}runWithRandom(t){this.spreadRandomCells(t),this.run()}spreadRandomCells(t,e=0,i=0,s=this.nxCells,r=this.nyCells,n=!0){for(let o=e;o<s;o++)for(let e=i;e<r;e++){const i=new t(o,e,this);i.init(),n&&i.random(),this.cells.set(i)}}*getCellsIterator(){for(const t of this.cells)yield t}prepareForUpdate(){this.old_cells=this.cells.copy()}tick(){if(this.static)return;const t=[];for(const e of this.getCellsIterator())e.updateParallel!=w.prototype.updateParallel?t[t.push(e.updateParallel())-1].cell=e:t[t.push({next:function(){return e.update(e.getMooreNeighbours()),{done:!0}}})-1].cell=e;for(let e=!1;!e;){e=!0;for(const i of t){const{value:t,done:s}=i.next();s&&t&&(cell._ssinternal.update_status=t),e&=s}}for(const t of this.getCellsIterator()){const e=t._ssinternal.become_cell;e&&this.cells.set(new e(t.x,t.y,this)).init()}this.cells.update&&this.cells.update()}}function v(t){const{minColor:e=[0,0,0],maxColor:i=[255,255,255],minValue:s=0,maxValue:r=1,diffuse:n=!1,decay:o=0,decayBase:c=0}=t;return class extends w{init(){this.value=0,this.delta=0}add(t){this.delta+=t}mult(t){this.add(this.value*(t-1))}getColor(){return h(e,i,(this.value-s)/r)}_diffuse(){let t=0;const e=this.getMooreNeighbours(),i=this.getMooreDistances();for(let s=0;s<e.length;s++)this>e[s]&&(t+=i[s]);for(let s=0;s<e.length;s++)if(this>e[s]){const r=(this-e[s])/t/i[s];e[s].curr.add(r),this.add(-r)}}_decay(){this>c&&this.add(-(this*o+c))}*updateParallel(){this.update(),yield,n&&this._diffuse(),o&&this._decay(),this.value+=this.delta,this.delta=0,this.value=a(this.value,s,r)}valueOf(){return this.value}}}var A="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function R(){var t=new A(16);return A!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function _(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}var C=function(t,e,i){var s=e[0],r=e[1],n=e[2],o=e[3],a=e[4],h=e[5],c=e[6],l=e[7],u=e[8],d=e[9],g=e[10],f=e[11],m=e[12],p=e[13],y=e[14],x=e[15],E=i[0],w=i[1],T=i[2],b=i[3];return t[0]=E*s+w*a+T*u+b*m,t[1]=E*r+w*h+T*d+b*p,t[2]=E*n+w*c+T*g+b*y,t[3]=E*o+w*l+T*f+b*x,E=i[4],w=i[5],T=i[6],b=i[7],t[4]=E*s+w*a+T*u+b*m,t[5]=E*r+w*h+T*d+b*p,t[6]=E*n+w*c+T*g+b*y,t[7]=E*o+w*l+T*f+b*x,E=i[8],w=i[9],T=i[10],b=i[11],t[8]=E*s+w*a+T*u+b*m,t[9]=E*r+w*h+T*d+b*p,t[10]=E*n+w*c+T*g+b*y,t[11]=E*o+w*l+T*f+b*x,E=i[12],w=i[13],T=i[14],b=i[15],t[12]=E*s+w*a+T*u+b*m,t[13]=E*r+w*h+T*d+b*p,t[14]=E*n+w*c+T*g+b*y,t[15]=E*o+w*l+T*f+b*x,t};class P extends e{constructor(t){super(t),this.init()}*getAgentsPartitionedByTexure(){for(const t of this.agents)yield[[t],(t.constructor.getTexture||t.getTexture).call(t)]}init(t,e){this.origin={x:0,y:0},this.scale=1,this.agents=new m,this.toSpawn=[],this.toDestroy=[],this.width=t,this.height=e}spreadRandom(t,e,i=this.origin.x,s=this.origin.y,n=this.width*this.scale,o=this.height*this.scale){for(let a=0;a<e;a++){const e=new t(r(i,n),r(s,o),this);e.init(),this.agents.push(e)}}spawn(t,e,i){this.toSpawn.push({agent:t,x:e,y:i})}destroy(t){for(let e=0;e<this.agents.length;e++)this.agents[e]._ssinternal.original==t&&this.toDestroy.push(e)}prepareForUpdate(){this.old_agents=this.agents.copy(),this.qtree=new f(new d(200,200,1,1),4);for(const t of this.old_agents)this.qtree=this.qtree.insert(t)}tick(){for(const t of this.agents)t.update();for(const t of this.toSpawn){const e=new t.agent(t.x,t.y,this);e.init(),this.agents.push(e)}this.toSpawn=[],this.toDestroy=[]}neighsWithin(t,e,i){return this.qtree.getInCircle(t.x,t.y,e)}}function M([t,...e]){if("number"==typeof t)return[t,...e];if(Array.isArray(t))return[...t,...e];if("x"in t)return[t.x,t.y,...e];throw new Error("unsuppored coord args",t,e)}class S{constructor(t=0,e=0,i=null){var s;this.x=t,this.y=e,this.ab=i,this._ssinternal={},this.transform=R(),(s=this.transform)[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this.scale=1}torusDifference(t,e,i,s){var r=Math.abs(i-t),n=Math.abs(s-e),o=n<50?n:100-n;return[r>(r<this.ab.width/2?r:this.ab.width-r)?t>i?this.ab.width-t+i:i-t-this.ab.width:i-t,n>o?e>s?this.ab.height-e+s:s-e-this.ab.height:s-e]}move(...t){const[e,i]=M(t);this.moveTo(this.x+e,this.y+i)}moveToward(...t){const[e,i,s]=M(t),[r,n]=this.torusDifference(this.x,this.y,e,i);this.move(r*s,n*s)}moveTo(...t){let[e,i]=M(t);const s=this.ab.width,r=this.ab.height;e>=s&&(e-=s),e<0&&(e=s+e),i>=r&&(i-=r),i<0&&(i=r+i),this.x=e,this.y=i,this.updateTransform()}updateTransform(){var t,e,i,s,r,n;_(this.transform,[this.x,this.y,0]),t=this.transform,e=this.transform,i=[this.scale,this.scale,0],s=i[0],r=i[1],n=i[2],t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}spawn(t,e=this.x,i=this.y){this.ab.spawn(t,e,i)}destroy(t){this.ab.destroy(t)}neighsWithin(t,e){return this.ab.neighsWithin(this,t,e)}on(t){return t.cells.get(Math.floor(this.x+.5),Math.floor(this.y+.5))}update(){}init(){}getColor(){return"#ff00ff"}}class U{initializeWebGLData(t,e){const i=this.gl;if(!i)throw new Error("Unable to initialize WebGL. Your browser or machine may not support it.");i.enable(i.BLEND),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.SRC_ALPHA,i.DST_ALPHA);const s=L(i,i.VERTEX_SHADER,"\n            attribute vec4 aVertexPosition;\n            attribute vec2 aTextureCoord;\n            uniform mat4 uProjectionMatrix;\n            varying highp vec2 vTextureCoord;\n            void main(void) {\n                gl_Position = uProjectionMatrix * aVertexPosition;\n                vTextureCoord = aTextureCoord;\n            }\n        "),r=L(i,i.VERTEX_SHADER,"\n            attribute vec4 aVertexPosition;\n            attribute vec2 aTextureCoord;\n            attribute mat4 aModelViewMatrix;\n            uniform mat4 uProjectionMatrix;\n            varying highp vec2 vTextureCoord;\n            void main(void) {\n                gl_Position = uProjectionMatrix * aModelViewMatrix * aVertexPosition;\n                vTextureCoord = aTextureCoord;\n            }\n        "),n=L(i,i.FRAGMENT_SHADER,"\n            varying highp vec2 vTextureCoord;\n            uniform sampler2D uSampler;\n            void main(void) {\n                gl_FragColor = texture2D(uSampler, vTextureCoord);\n            }\n        "),o=i.createProgram();if(i.attachShader(o,s),i.attachShader(o,n),i.linkProgram(o),!i.getProgramParameter(o,i.LINK_STATUS))throw new Error("Unable to initialize the shader program: "+i.getProgramInfoLog(o));const a=i.createProgram();if(i.attachShader(a,r),i.attachShader(a,n),i.linkProgram(a),!i.getProgramParameter(a,i.LINK_STATUS))throw new Error("Unable to initialize the shader program: "+i.getProgramInfoLog(o));this.uprojectionMatrix=i.getUniformLocation(o,"uProjectionMatrix"),this.uSampler=i.getUniformLocation(o,"uSampler"),this.shaderProgram=o,this.uprojectionMatrixInstanced=i.getUniformLocation(a,"uProjectionMatrix"),this.uSamplerInstanced=i.getUniformLocation(a,"uSampler"),this.shaderProgramInstanced=a;const h=[t+0,e+0,-0,e+0,t+0,-0,-0,-0],c=[(t+0)/t,(e+0)/e,-0/t,(e+0)/e,(t+0)/t,-0/e,-0/t,-0/e],l=[0,1,2,1,2,3];function u(t,e){const s=i.createBuffer();return i.bindBuffer(t,s),i.bufferData(t,e,i.STATIC_DRAW),s}function d(t,e){const s=i.getAttribLocation(t,e);i.enableVertexAttribArray(s),i.vertexAttribPointer(s,2,i.FLOAT,!1,0,0)}this.VAO=i.createVertexArray(),i.bindVertexArray(this.VAO),u(i.ARRAY_BUFFER,new Float32Array(h)),d(o,"aVertexPosition"),u(i.ARRAY_BUFFER,new Float32Array(c)),d(o,"aTextureCoord"),this.EBO=u(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(l)),this.VAOInstanced=i.createVertexArray(),i.bindVertexArray(this.VAOInstanced),u(i.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0])),d(a,"aVertexPosition"),u(i.ARRAY_BUFFER,new Float32Array(c)),d(a,"aTextureCoord"),this.agentsBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.agentsBuffer);let g=i.getAttribLocation(a,"aModelViewMatrix");for(var f=0;f<4;++f)i.vertexAttribDivisor(g+f,1),i.enableVertexAttribArray(g+f),i.vertexAttribPointer(g+f,4,i.FLOAT,0,64,16*f);this.EBOInstanced=u(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(l));const m=i.createTexture();i.bindTexture(i.TEXTURE_2D,m),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.UNSIGNED_BYTE,new Uint8Array(this.width*this.height*4)),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),this.texture=m}constructor(t,e,i,s,r){this.sim=t,this.gl=e.getContext("webgl2"),this.width=i,this.height=s,console.log(i,e.width,s,e.height),this.initializeWebGLData(i,s),this.textures={},this.image=new Uint8Array(this.width*this.height*4);const n=e.width/2/(e.width/i),o=e.height/2/(e.height/s);this.scaleX=1/n,this.scaleY=1/o,this.translateX=-n,this.translateY=-o,this.projectionMatrix=R(),this.updateProjectionMatrix()}loadTexture(t){const e=this.gl,i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([255,0,255,255]));const s=new Image;s.onload=function(){e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},s.src=t,this.textures[t]=i}clickToCanvasCoordinates(t){const e=t.target.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,r=i/t.target.scrollWidth*2-1,n=s/t.target.scrollHeight*2-1;return[r/this.scaleX-this.translateX,n/this.scaleY-this.translateY]}updateProjectionMatrix(){const t=R();var e,i;e=t,i=[this.scaleX,-this.scaleY,1],e[0]=i[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=i[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1;const s=R();_(s,[this.translateX,this.translateY,0]),C(t,t,s),this.projectionMatrix=t}onZoom(t){let[e,i]=this.clickToCanvasCoordinates(t);const s=this.translateX,r=this.translateY;this.translateX=-e,this.translateY=-i;let n=1-.002*t.deltaY;this.scaleX*=n,this.scaleY*=n,this.translateX+=(s+e)/n,this.translateY+=(r+i)/n,console.log(e,i,this.translateX,this.translateY),this.updateProjectionMatrix(),this.draw()}onPan(t){let[e,i]=this.clickToCanvasCoordinates(t);if(1&t.buttons){let[t,s]=this.clickToCanvasCoordinates(this.pMouseEvent);this.translateX+=e-t,this.translateY+=i-s}this.pMouseEvent=t,this.updateProjectionMatrix(),this.draw()}onEnter(t){this.pMouseEvent=t}drawCALayer(t){const e=this.gl;e.useProgram(this.shaderProgram),e.uniformMatrix4fv(this.uprojectionMatrix,!1,this.projectionMatrix),e.bindVertexArray(this.VAO),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture);for(const e of t.cells){const t=e.getColor(),i=4*(e.y*this.width+e.x);t?(this.image[i+0]=t[0],this.image[i+1]=t[1],this.image[i+2]=t[2],this.image[i+3]=3==t.length?255:t[3]):this.image[i+3]=0}e.texSubImage2D(e.TEXTURE_2D,0,0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,this.image),e.uniform1i(this.uSampler,0),e.drawElementsInstanced(e.TRIANGLES,6,e.UNSIGNED_SHORT,0,4)}drawABLayer(t){const e=this.gl;e.useProgram(this.shaderProgramInstanced),e.uniformMatrix4fv(this.uprojectionMatrixInstanced,!1,this.projectionMatrix);for(const[i,s]of t.getAgentsPartitionedByTexure()){const t=this.textures[s]||this.loadTexture(s);e.bindVertexArray(this.VAOInstanced),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t);let r=[];for(const t of i)r.push(...t.transform);e.bindBuffer(e.ARRAY_BUFFER,this.agentsBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.DYNAMIC_DRAW),e.uniform1i(this.uSamplerInstanced,0),e.uniform1i(this.uSamplerInstanced,0),e.drawElementsInstanced(e.TRIANGLES,6,e.UNSIGNED_SHORT,0,i.length)}}draw(t=0){const e=this.gl;e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT);for(const t of this.sim.layers)t.visible&&(t instanceof b?this.drawCALayer(t):t instanceof P&&this.drawABLayer(t))}}function L(t,e,i){const s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(console.error("An error occurred compiling the shaders: "+t.getShaderInfoLog(s)),t.deleteShader(s),null)}class D{constructor(s,r,n,o={}){let{canvas:a,scale:h,init:c,tick:l}=o;this.initFunction=c,this.tickFunction=l,this.layers=n=n instanceof e?[n]:n,this.xsize=s,this.ysize=r,a=function(t,e,s,r){return s||r?!s&&r?i(t*r,e*r):s instanceof HTMLCanvasElement?s:s.width&&s.height?i(s.width,s.height):void 0:i(t,e)}(s,r,a,h),console.log(a),a.addEventListener("click",t=>this.layers.forEach(e=>{const[i,s]=this.renderer.clickToCanvasCoordinates(t);e.onClick(i,s),this.renderer.draw()})),a.addEventListener("mouseenter",t=>this.renderer.onEnter(t)),a.addEventListener("mousemove",t=>this.renderer.onPan(t)),a.addEventListener("wheel",t=>this.renderer.onZoom(t)),this.renderer=new U(this,a,s,r,{scale:h}),this.frameCounter=new t(10),this.running=!1,this.startLoop(),this.init()}init(){for(const t of this.layers)t.init(this.xsize,this.ysize);this.initFunction&&this.initFunction(this),this.renderer.draw()}startLoop(){this.running&&this.tick(),requestAnimationFrame(()=>this.startLoop())}tick(){for(const t of this.layers)t.prepareForUpdate();for(const t of this.layers)t.tick();this.tickFunction&&this.tickFunction(this),this.renderer.draw(),this.frameCounter.update()}pause(){this.running=!1}resume(){this.running=!0}}function F(t){return function(e,i,s,r,n){const o=new t(s,n),a=new D(e,i,o,r);return new Proxy({},{get:(t,e)=>{const i=t=>t[e]instanceof Function?t[e].bind(t):t[e];return"layer"==e?o:"simulation"==e?a:e in a?i(a):e in o?i(o):void 0}})}}const I=F(b),B=F(P);let N=0;function X(){return"__ssid"+N++}function k(t,e=document.body){const i=document.createElement("div");for(const e of t.layers)i.appendChild((s=(()=>{e.visible^=1,t.renderer.draw()}),r=void 0,(r=document.createElement("input")).type="checkbox",document.body.appendChild(r),r.addEventListener("click",s),r));var s,r;return e.appendChild(i)}function Y(t,e,i=document.body){const s=X(),r=[],n=()=>t.forEach((t,e)=>t.visible=r[e].checked),o=document.createElement("div");for(let i=0;i<t.length;i++){let t=document.createElement("input");t.type="radio",t.value=i,t.name=s,t.id=X(),document.body.appendChild(t),o.appendChild(t);G(t,e[i],o);t.addEventListener("click",n),r.push(t)}return i.appendChild(o)}function V(t,e=document.body){const i=document.createElement("div");return i.appendChild(s(()=>t.pause(),"Pause")),i.appendChild(s(()=>t.resume(),"Resume")),i.appendChild(s(()=>t.tick(),"Step")),i.appendChild(s(()=>t.init(),"Restart")),e.appendChild(i)}function O(t,e,i,s,r,n=t[e],o=document.body){void 0!==n&&(t[e]=n);const a=document.createElement("input");return a.type="range",a.min=i,a.max=s,a.step=r,a.value=t[e],a.addEventListener("input",i=>{t[e]=a.value}),o.appendChild(a)}function j(t,e,i=document.body,s=t[e]){const r=document.createElement("input");switch(s.constructor){case String:r.type="text";break;case Number:r.type="number";break;case Boolean:r.type="checkbox"}return r.value=t[e],r.addEventListener("input",i=>{t[e]=r.value}),i.appendChild(r)}function G(t,e,i){let s=document.createElement("label");return s.htmlFor=t.id,s.innerText=e,i.appendChild(s),s}export{I as CellularAutomata,w as Cell,T as EmptyCell,B as AgentBased,P as ABLayer,S as Agent,D as Simulation,b as CALayer,v as makeCell,V as createTimeControls,k as createLayerControls,j as createPropertyControl,O as createPropertySlider,Y as createLayerGroupControl,G as createLabel,r as random,i as createCanvas,s as createButton,n as map,a as clamp,o as hueToRgb,h as gradient,c as chance,l as weightedChooseDo};
